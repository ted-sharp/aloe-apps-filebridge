@page "/settings"
@using Aloe.Apps.FileBridgeLib.Models
@using Aloe.Apps.FileBridgeLib.Services
@inject AppConfigManagerService AppConfigManager
@inject NavigationManager Navigation

<PageTitle>設定 - FileBridge</PageTitle>

<header>
    <hgroup>
        <h1>アプリ設定</h1>
        <p>現在のアプリ設定を確認できます</p>
    </hgroup>
    <nav>
        <button @onclick="NavigateToLogs" class="secondary">ログ</button>
        <button @onclick="NavigateToHome" class="secondary">ホーム</button>
    </nav>
</header>

<article>
    @if (apps == null)
    {
        <p><em>読み込み中...</em></p>
    }
    else if (!apps.Any())
    {
        <p><em>アプリ設定がありません。</em></p>
    }
    else
    {
        @foreach (var app in apps)
        {
            <details>
                <summary><strong>@app.Name</strong></summary>
                <dl>
                    <dt>監視ディレクトリ</dt>
                    <dd>@app.WatchDirectory</dd>
                    
                    <dt>ポーリング間隔</dt>
                    <dd>@app.PollingIntervalSeconds 秒</dd>
                    
                    <dt>実行ファイルパス</dt>
                    <dd>@(string.IsNullOrEmpty(app.ExecutablePath) ? "(未設定)" : app.ExecutablePath)</dd>
                    
                    <dt>引数</dt>
                    <dd>@(string.IsNullOrEmpty(app.Arguments) ? "(未設定)" : app.Arguments)</dd>
                    
                    <dt>ログディレクトリ</dt>
                    <dd>@app.LogDirectory</dd>
                    
                    <dt>ログ保持日数</dt>
                    <dd>@app.LogRetentionDays 日</dd>
                    
                    <dt>1ファイルあたりの最大ログ数</dt>
                    <dd>@app.MaxLogsPerFile</dd>
                </dl>
            </details>
        }
    }
</article>

@code {
    private List<FileBridgeOptions>? apps;

    protected override async Task OnInitializedAsync()
    {
        await LoadApps();
    }

    private async Task LoadApps()
    {
        try
        {
            apps = AppConfigManager.GetAllConfigs();
            if (apps == null || apps.Count == 0)
            {
                // 設定が読み込まれていない場合は読み込む
                await AppConfigManager.LoadConfigsAsync();
                apps = AppConfigManager.GetAllConfigs();
            }
        }
        catch (Exception ex)
        {
            // エラーは無視（設定が存在しない場合など）
            apps = new List<FileBridgeOptions>();
        }
    }

    private void NavigateToLogs()
    {
        Navigation.NavigateTo("/logs");
    }

    private void NavigateToHome()
    {
        Navigation.NavigateTo("/");
    }
}
