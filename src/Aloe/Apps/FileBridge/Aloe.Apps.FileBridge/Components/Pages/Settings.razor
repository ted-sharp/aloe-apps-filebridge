@page "/settings"
@using Aloe.Apps.FileBridgeLib.Models
@using Microsoft.Extensions.Options
@inject IOptions<FileBridgeOptions> GlobalFileBridgeOptions
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>設定 - FileBridge</PageTitle>

<main class="container">
    <nav>
        <hgroup>
            <h1>アプリ設定</h1>
            <p>現在のアプリ設定を確認できます</p>
        </hgroup>
        <button class="icon-button" @onclick="NavigateToHome" title="ホームへ戻る">
            <i data-lucide="x"></i>
        </button>
    </nav>

    <article>
        <h3>FileBridge のログ設定</h3>
        <p>操作ログ（カスタムログ）の保存先と保持設定です。appsettings.json の FileBridge セクションで変更できます。</p>
        @{
            var opts = GlobalFileBridgeOptions.Value;
        }
        <dl>
            <dt>ログディレクトリ</dt>
            <dd>@opts.LogDirectory</dd>
            <dt>ログ保持日数</dt>
            <dd>@opts.LogRetentionDays 日</dd>
            <dt>1ファイルあたりの最大ログ数</dt>
            <dd>@opts.MaxLogsPerFile</dd>
        </dl>
    </article>

    <article>
        <h3>監視・プロセス起動設定</h3>
        <p>監視ディレクトリとファイル検知時に起動する exe の設定です。appsettings.json の FileBridge セクションで変更できます。</p>
        <dl>
            <dt>監視ディレクトリ</dt>
            <dd>@opts.WatchDirectory</dd>

            <dt>ポーリング間隔</dt>
            <dd>@opts.PollingIntervalSeconds 秒</dd>

            <dt>実行ファイルパス</dt>
            <dd>@(string.IsNullOrEmpty(opts.ExecutablePath) ? "（未設定）" : opts.ExecutablePath)</dd>

            <dt>引数</dt>
            <dd>@(string.IsNullOrEmpty(opts.Arguments) ? "（未設定）" : opts.Arguments)</dd>
            <p><small>利用可能なプレースホルダー: {FilePath}（ファイルパス）, {FolderPath}（フォルダパス）</small></p>

            <dt>無視する拡張子</dt>
            <dd>@(opts.IgnoreExtensions != null && opts.IgnoreExtensions.Count > 0 ? string.Join(", ", opts.IgnoreExtensions) : "（なし）")</dd>

            <dt>マーカーファイルパターン</dt>
            <dd>@(opts.MarkerFilePatterns != null && opts.MarkerFilePatterns.Count > 0 ? string.Join(", ", opts.MarkerFilePatterns) : "（なし）")</dd>

            <dt>サイズ安定チェック間隔</dt>
            <dd>@(opts.SizeCheckIntervalMs > 0 ? $"{opts.SizeCheckIntervalMs} ms" : "無効")</dd>

            <dt>サイズ安定チェック回数</dt>
            <dd>@opts.SizeStabilityCheckCount 回</dd>
        </dl>
    </article>
</main>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                await JS.InvokeVoidAsync("lucide.createIcons");
            }
            catch { }
        }
    }

    private void NavigateToHome()
    {
        Navigation.NavigateTo("/");
    }
}
