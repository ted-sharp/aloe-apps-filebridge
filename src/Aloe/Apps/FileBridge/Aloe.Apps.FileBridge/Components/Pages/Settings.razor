@page "/settings"
@using Aloe.Apps.FileBridgeLib.Models
@using Aloe.Apps.FileBridgeLib.Services
@using Microsoft.Extensions.Options
@inject AppConfigManagerService AppConfigManager
@inject IOptions<FileBridgeOptions> GlobalFileBridgeOptions
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>設定 - FileBridge</PageTitle>

<main class="container">
    <nav>
        <hgroup>
            <h1>アプリ設定</h1>
            <p>現在のアプリ設定を確認できます</p>
        </hgroup>
        <button class="icon-button" @onclick="NavigateToHome" title="ホームへ戻る">
            <i data-lucide="x"></i>
        </button>
    </nav>

    <article>
        <h3>FileBridge のログ設定</h3>
        <p>操作ログ（カスタムログ）の保存先と保持設定です。appsettings.json の FileBridge セクションで変更できます。</p>
        @{
            var globalOpts = GlobalFileBridgeOptions.Value;
        }
        <dl>
            <dt>ログディレクトリ</dt>
            <dd>@globalOpts.LogDirectory</dd>
            <dt>ログ保持日数</dt>
            <dd>@globalOpts.LogRetentionDays 日</dd>
            <dt>1ファイルあたりの最大ログ数</dt>
            <dd>@globalOpts.MaxLogsPerFile</dd>
        </dl>
    </article>

    <article>
        <h3>アプリ設定</h3>
        @if (apps == null)
        {
            <p aria-busy="true">読み込み中...</p>
        }
        else if (!apps.Any())
        {
            <p>アプリ設定がありません。</p>
        }
        else
        {
            @foreach (var app in apps)
            {
                <details>
                    <summary><i data-lucide="folder" style="vertical-align: middle; width: 1rem; height: 1rem;"></i> <strong>@app.Name</strong></summary>
                    <dl>
                        <dt>監視ディレクトリ</dt>
                        <dd>@app.WatchDirectory</dd>

                        <dt>ポーリング間隔</dt>
                        <dd>@app.PollingIntervalSeconds 秒</dd>

                        <dt>実行ファイルパス</dt>
                        <dd>@(string.IsNullOrEmpty(app.ExecutablePath) ? "（未設定）" : app.ExecutablePath)</dd>

                        <dt>引数</dt>
                        <dd>@(string.IsNullOrEmpty(app.Arguments) ? "（未設定）" : app.Arguments)</dd>

                        <dt>無視する拡張子</dt>
                        <dd>@(app.IgnoreExtensions != null && app.IgnoreExtensions.Count > 0 ? string.Join(", ", app.IgnoreExtensions) : "（なし）")</dd>

                        <dt>マーカーファイルパターン</dt>
                        <dd>@(app.MarkerFilePatterns != null && app.MarkerFilePatterns.Count > 0 ? string.Join(", ", app.MarkerFilePatterns) : "（なし）")</dd>

                        <dt>サイズ安定チェック間隔</dt>
                        <dd>@(app.SizeCheckIntervalMs > 0 ? $"{app.SizeCheckIntervalMs} ms" : "無効")</dd>

                        <dt>サイズ安定チェック回数</dt>
                        <dd>@app.SizeStabilityCheckCount 回</dd>
                    </dl>
                </details>
            }
        }
    </article>
</main>

@code {
    private List<FileBridgeOptions>? apps;

    protected override async Task OnInitializedAsync()
    {
        await LoadApps();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                await JS.InvokeVoidAsync("lucide.createIcons");
            }
            catch { }
        }
    }

    private async Task LoadApps()
    {
        try
        {
            apps = AppConfigManager.GetAllConfigs();
            if (apps == null || apps.Count == 0)
            {
                await AppConfigManager.LoadConfigsAsync();
                apps = AppConfigManager.GetAllConfigs();
            }
        }
        catch (Exception)
        {
            apps = new List<FileBridgeOptions>();
        }
    }

    private void NavigateToHome()
    {
        Navigation.NavigateTo("/");
    }
}
