@page "/logs"
@using Aloe.Apps.FileBridgeLib.Models
@using Aloe.Apps.FileBridgeLib.Services
@using Microsoft.Extensions.Options
@inject OperationLogService LogService
@inject FileWatcherService FileWatcherService
@inject IOptions<FileBridgeOptions> Options
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>アプリ監視ログ - FileBridge</PageTitle>

<main class="container">
    <nav>
        <hgroup>
            <h1>FileBridge アプリ監視ログ</h1>
            <p>FileBridgeの監視・プロセス起動に関するログ（ファイルイベント、プロセス起動、エラーなど）を表示します</p>
        </hgroup>
        <button class="icon-button" @onclick="NavigateToHome" title="ホームへ戻る">
            <i data-lucide="x"></i>
        </button>
    </nav>

    <article>
        <form @onsubmit="ApplyFilters">
            <div class="grid">
                <label>
                    ログタイプ
                    <select @bind="selectedLogTypeStr" @bind:after="OnFilterChanged">
                        <option value="">すべて</option>
                        <option value="FileEvent">ファイルイベント</option>
                        <option value="ProcessLaunch">プロセス起動</option>
                        <option value="ProcessError">プロセスエラー</option>
                        <option value="WatcherError">監視エラー</option>
                    </select>
                </label>
                <label>
                    開始日
                    <input type="date" @bind="StartDate" @bind:after="OnFilterChanged" />
                </label>
                <label>
                    終了日
                    <input type="date" @bind="EndDate" @bind:after="OnFilterChanged" />
                </label>
            </div>
            <div role="group">
                <button type="submit"><i data-lucide="filter"></i>フィルター適用</button>
                <button type="button" class="secondary" @onclick="ClearFilters">フィルタークリア</button>
            </div>
        </form>
    </article>

    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
        <button type="button" @onclick="RunImmediateScan" disabled="@isScanning">
            <i data-lucide="scan-search"></i>手動スキャン
        </button>
        @if (scanResultMessage != null)
        {
            <small>@scanResultMessage</small>
        }
    </div>

    @if (logs == null)
    {
        <article aria-busy="true">読み込み中...</article>
    }
    else if (!logs.Any())
    {
        <article>
            <p>ログがありません</p>
        </article>
    }
    else
    {
        <article>
            <div class="table-overflow">
                <table>
                    <thead>
                        <tr>
                            <th scope="col" class="cell-nowrap" style="width: 150px">時刻</th>
                            <th scope="col" style="width: 140px">タイプ</th>
                            <th scope="col">メッセージ</th>
                            <th scope="col" style="width: 100px">詳細</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var log in logs)
                        {
                            <tr>
                                <td class="cell-nowrap">@ToDisplayTime(log.Timestamp).ToString("yyyy-MM-dd HH:mm:ss.fff")</td>
                                <td>
                                    <span class="status-badge @GetStatusBadgeClass(log.LogType)">
                                        <i data-lucide="@GetStatusIcon(log.LogType)"></i>
                                        <span>@GetLogTypeLabel(log.LogType)</span>
                                    </span>
                                </td>
                                <td>@log.Message</td>
                                <td>
                                    @if (!string.IsNullOrEmpty(log.Details))
                                    {
                                        <button type="button" class="secondary outline" style="margin: 0;" @onclick="() => ShowDetails(log)">詳細</button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            @if (totalPages > 1)
            {
                <nav aria-label="ページネーション">
                    <div role="group" style="display: flex; justify-content: center; align-items: center; gap: 0.5rem;">
                        @if (currentPage > 1)
                        {
                            <button type="button" @onclick="() => ChangePage(currentPage - 1)"><i data-lucide="chevron-left"></i>前へ</button>
                        }
                        <span>ページ @currentPage / @totalPages</span>
                        @if (currentPage < totalPages)
                        {
                            <button type="button" @onclick="() => ChangePage(currentPage + 1)">次へ<i data-lucide="chevron-right"></i></button>
                        }
                    </div>
                </nav>
            }
        </article>
    }
</main>

@if (selectedLog != null)
{
    <dialog open>
        <article>
            <header>
                <h3 style="margin: 0;">ログ詳細</h3>
                <button type="button" class="icon-button" aria-label="閉じる" @onclick="CloseDetails">
                    <i data-lucide="x"></i>
                </button>
            </header>
            <dl>
                <dt>ID</dt>
                <dd>@selectedLog.Id</dd>
                <dt>時刻</dt>
                <dd>@ToDisplayTime(selectedLog.Timestamp).ToString("yyyy-MM-dd HH:mm:ss.fff")</dd>
                <dt>タイプ</dt>
                <dd>
                    <span class="status-badge @GetStatusBadgeClass(selectedLog.LogType)">
                        <i data-lucide="@GetStatusIcon(selectedLog.LogType)"></i>
                        <span>@GetLogTypeLabel(selectedLog.LogType)</span>
                    </span>
                </dd>
                <dt>メッセージ</dt>
                <dd>@selectedLog.Message</dd>
                @if (!string.IsNullOrEmpty(selectedLog.Details))
                {
                    <dt>詳細</dt>
                    <dd>
                        <pre><code>@selectedLog.Details</code></pre>
                    </dd>
                }
            </dl>
            <footer>
                <button type="button" @onclick="CloseDetails">閉じる</button>
            </footer>
        </article>
    </dialog>
}

@code {
    private List<OperationLogEntry>? logs;
    private OperationLogEntry? selectedLog;
    private string? selectedLogTypeStr;
    private bool isScanning;
    private string? scanResultMessage;
    private LogType? SelectedLogType => string.IsNullOrEmpty(selectedLogTypeStr) ? null : Enum.Parse<LogType>(selectedLogTypeStr);
    private DateTime? StartDate { get; set; } = DateTime.Today.AddDays(-7);
    private DateTime? EndDate { get; set; } = DateTime.Today;
    private int currentPage = 1;
    private const int pageSize = 50;
    private int totalPages = 1;
    private bool iconsInitialized = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadLogs();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !iconsInitialized)
        {
            try
            {
                await JS.InvokeVoidAsync("lucide.createIcons");
                iconsInitialized = true;
            }
            catch { }
        }
    }

    private async Task LoadLogs()
    {
        try
        {
            var (pagedLogs, totalCount) = await LogService.GetLogsAsync(
                StartDate,
                EndDate,
                SelectedLogType,
                currentPage,
                pageSize);

            logs = pagedLogs;
            totalPages = Math.Max(1, (totalCount + pageSize - 1) / pageSize);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ログ読み込みエラー: {ex.Message}");
        }
    }

    private async Task ApplyFilters()
    {
        currentPage = 1;
        await LoadLogs();
    }

    private async Task OnFilterChanged()
    {
        currentPage = 1;
        await LoadLogs();
    }

    private async Task ClearFilters()
    {
        selectedLogTypeStr = null;
        StartDate = DateTime.Today.AddDays(-7);
        EndDate = DateTime.Today;
        currentPage = 1;
        await LoadLogs();
    }

    private async Task ChangePage(int page)
    {
        if (page >= 1 && page <= totalPages)
        {
            currentPage = page;
            await LoadLogs();
        }
    }

    private void ShowDetails(OperationLogEntry log)
    {
        selectedLog = log;
    }

    private void CloseDetails()
    {
        selectedLog = null;
    }

    private string GetLogTypeLabel(LogType logType)
    {
        return logType switch
        {
            LogType.FileEvent => "ファイルイベント",
            LogType.ProcessLaunch => "プロセス起動",
            LogType.ProcessError => "プロセスエラー",
            LogType.WatcherError => "監視エラー",
            _ => logType.ToString()
        };
    }

    private string GetStatusBadgeClass(LogType logType)
    {
        return logType switch
        {
            LogType.FileEvent => "status-badge-running",
            LogType.ProcessLaunch => "status-badge-transition",
            LogType.ProcessError => "status-badge-stopped",
            LogType.WatcherError => "status-badge-paused",
            _ => "status-badge-unknown"
        };
    }

    private string GetStatusIcon(LogType logType)
    {
        return logType switch
        {
            LogType.FileEvent => "file-input",
            LogType.ProcessLaunch => "play-circle",
            LogType.ProcessError => "alert-circle",
            LogType.WatcherError => "alert-triangle",
            _ => "help-circle"
        };
    }

    private async Task RunImmediateScan()
    {
        isScanning = true;
        scanResultMessage = null;
        StateHasChanged();

        var count = FileWatcherService.TriggerImmediateScan();
        scanResultMessage = count > 0
            ? $"{count} 件のファイルをキューに投入しました"
            : "新しいファイルはありませんでした";

        isScanning = false;
        _ = Task.Run(async () =>
        {
            await Task.Delay(5000);
            scanResultMessage = null;
            await InvokeAsync(StateHasChanged);
        });
    }

    private DateTime ToDisplayTime(DateTime utcTime)
    {
        var tz = TimeZoneInfo.FindSystemTimeZoneById(Options.Value.DisplayTimeZoneId);
        return TimeZoneInfo.ConvertTimeFromUtc(utcTime, tz);
    }

    private void NavigateToHome()
    {
        Navigation.NavigateTo("/");
    }
}
